### 计网：传输层、网络层（Ping原理、TCP三次握手、四次挥手、拥塞控制、UDP的不可靠、一对一、一对多）

**什么是Ping?**

Ping是 ICMP 的一个重要应用，主要用来测试两个主机直接的连通性。（ping 属于网络层）

**Ping的原理**

Ping的原理是通过向主机发送ICMP Echo 请求报文，目的主机收到后会发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率。

Echo (回送)  用途是为了请求或者回答。

**什么是ICMP？**

ICMP叫 *网际控制报文协议*，是为了更有效地转发IP数据报和提高交付成功的机会。它封装在IP数据报中，但是不是高层协议。

**TCP 的三次握手？**

![img](C:\Users\Administrator\Desktop\notes\assets\e92d0ebc-7d46-413b-aec1-34a39602f787.png)

假设A为客户端，B为服务端。首先B处于监听状态，等待客户端的连接。A向B发送连接请求报文，SYN=1，ACK=0，选择一个初始值为x的序列号，B在收到A的请求报文之后，如果同意连接，则向A发送一个确认请求的报文，SYN=1，ACK=1，确认号为x+1，同时选择一个初始值为y 的序列号。A收到B的连接确认报文后，再想B发送一个确认报文，ACK=1，序号为x+1，确认号为 y+1，B在收到A的确认后，连接建立。

**为什么要进行三次握手**

前两次握手是因为正常的请求和确认。第三次握手是为了防止失效的连接请求到达服务器，让服务器错误地打开连接。客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能接收到服务端传回的确认连接。客户端在等待一个超时重传之后，会重新请求连接。但是这个滞留的连接请求最后依然会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。如果进行三次握手，客户端会忽略服务器之后发送的对滞留连接请求的确认连接，不进行第三次握手，因此就不会打开连接。

**TCP的四次挥手？**

![img](C:\Users\Administrator\Desktop\notes\assets\f87afe72-c2df-4c12-ac03-9b8d581a8af8.jpg)

四次挥手的过程：A向B发送连接释放报文，FIN=1，初始化一个序列号为u。B收到之后发出确认，此时B处于半关闭状态，即B能向A发送数据但是A不能向B发送数据。当B不需要连接之后，B向A发送释放报文，此时ACK=1，FIN=1，确认号为u+1，同时初始化一个序列号w。A 收到B的释放报文后，发出确认报文，此时 ACK=1，确认号为w+1,序列号为u+1，进入TIME-WAIT状态，等待两个最大报文存活时间后发送释放连接。B收到A的确认后释放连接。

**为什么要进行四次挥手**

客户端发送了FIN的连接释放报文之后，服务器收到了这个报文，进入CLOSE-WAIT状态，这个状态是为了让服务器发送还未传送完毕的数据，传送完毕后，服务器会发送FIN连接释放报文。客户机的TIME-WAIT状态，客户端在收到服务器发送而来的释放报文之后，并不直接进入CLOSE状态，而是等待一个时间计时器的时间，这样做是有两个目的，第一个目的是确认最后的确认报文能够到达。如果B没收到A发来的最后的确认报文，A重新发送释放连接的确认报文。第二个目的是，等一段时间，让此连接时间内产生的所有报文都从网络中消失，以免下一个新的连接中会出现旧的连接请求报文。

**名词解释**

*序号：* 用于对字节流报文进行编号。

*确认号：* 期望收到的下一个报文段的序号。

*确认ACK：* ACK=1 时确认号字段有效，否则无效。

*同步 SYN：* SYN=1 ACK=0 则说明这是一个连接请求报文段。若对方同意建立连接，则响应报文中SYN=1 ACK=1。

*终止FIN：* FIN=1 请求释放连接。

